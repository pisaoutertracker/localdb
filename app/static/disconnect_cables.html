<!DOCTYPE html>
<html>
<head>
    <title>Disconnect Cables</title>
    <link rel="stylesheet" href="/static/nav.css">
    <script src="/static/nav.js" defer></script>
    <!-- Prevent browser caching of this page -->
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { display: flex; align-items: center; gap: 20px; }
        .box { border: 2px solid #000; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .detbox { border: 2px solid #000; padding: 10px; width: 200px; height: 200px; background-color: #666666; display: flex; flex-direction: column; align-items: center; }
        .cratebox { border: 2px solid #000; padding: 10px; width: 200px; height: 200px; background-color: #ff0000; display: flex; flex-direction: column; align-items: center; }
        select { margin-top: 10px; padding: 5px; }
        button { padding: 10px 20px; font-size: 16px; }
    </style>
</head>
<body style="margin-top:46px;">
<h1 style="margin-top:0">Disconnect Cables</h1>

<form id="disconnectForm">
    <div class="container">
        <div class="detbox">
            <label for="cableSelectDet">Cable DetSide:</label>
            <select id="cableSelectDet"></select>
        </div>
        <div class="box">
            <label for="portSelectDet">Port:</label>
            <select id="portSelectDet"></select>
        </div>
        <div class="box">
            <label for="portSelectCrate">Port:</label>
            <select id="portSelectCrate"></select>
        </div>
        <div class="cratebox">
            <label for="cableSelectCrate">Cable CrateSide:</label>
            <select id="cableSelectCrate"></select>
        </div>
        <button type="submit">Disconnect</button>
    </div>
    <div id="responseOutput"></div>

</form>

<script>
    // Fetch the list of available cables
    fetch('/cables')
        .then(response => response.json())
        .then(data => {
            const cableSelectDet = document.getElementById('cableSelectDet');
            const cableSelectCrate = document.getElementById('cableSelectCrate');
            const portSelectDet = document.getElementById('portSelectDet');
            const portSelectCrate = document.getElementById('portSelectCrate');

            let detCables = [];
            let crateCables = [];
            for (const cable of data) { detCables.push(cable.name); crateCables.push(cable.name); }
            detCables.sort(); crateCables.sort();
            for (const cableName of detCables) { const optionDet = document.createElement('option'); optionDet.value = cableName; optionDet.text = cableName; cableSelectDet.appendChild(optionDet); }
            for (const cableName of crateCables) { const optionCrate = document.createElement('option'); optionCrate.value = cableName; optionCrate.text = cableName; cableSelectCrate.appendChild(optionCrate); }
        });

    document.getElementById('cableSelectDet').addEventListener('change', function(event) {
        const cable = event.target.value;
        fetch(`/cables/${cable}`)
            .then(response => response.json())
            .then(data => {
                var cableTemplate = data.type || 'module';
                fetch(`/cable_templates/${cableTemplate}`)
                    .then(response => response.json())
                    .then(templateData => {
                        const portSelectDet = document.getElementById('portSelectDet');
                        portSelectDet.innerHTML = '';
                        for (const port in templateData.crateSide) { const option = document.createElement('option'); option.value = port; option.text = port; portSelectDet.appendChild(option); }
                    });
            });
    });

    // add modules as cables on detside list
    fetch('/modules')
        .then(response => response.json())
        .then(data => {
            const cableSelectDet = document.getElementById('cableSelectDet');
            let moduleNames = [];
            for (const module of data) { if (module && module.moduleName) moduleNames.push(module.moduleName); }
            moduleNames.sort();
            for (const moduleName of moduleNames) { const optionDet = document.createElement('option'); optionDet.value = moduleName; optionDet.text = moduleName; cableSelectDet.appendChild(optionDet); }
        });

    document.getElementById('cableSelectCrate').addEventListener('change', function(event) {
        const cable = event.target.value;
        fetch(`/cables/${cable}`).then(response => response.json()).then(data => {
            const cableTemplate = data.type || 'module';
            fetch(`/cable_templates/${cableTemplate}`).then(response => response.json()).then(templateData => {
                const portSelectCrate = document.getElementById('portSelectCrate');
                portSelectCrate.innerHTML = '';
                for (const port in templateData.detSide) { const option = document.createElement('option'); option.value = port; option.text = port; portSelectCrate.appendChild(option); }
            });
        });
    });

    document.getElementById('disconnectForm').addEventListener('submit', function(event) {
        event.preventDefault();
        let cable1 = document.getElementById('cableSelectDet').value;
        let port1 = document.getElementById('portSelectDet').value;
        let cable2 = document.getElementById('cableSelectCrate').value;
        let port2 = document.getElementById('portSelectCrate').value;
        if (!cable1 || !cable2) { alert('Please select both cables'); return; }
        const payload = port1 && port2 ? { cable1, port1, cable2, port2 } : { cable1, cable2 };
        fetch('/disconnect', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(response => response.json())
            .then(data => {
                const currentTime = new Date().toLocaleString();
                const responseOutput = document.getElementById('responseOutput');
                responseOutput.innerHTML += `<p>Response: ${JSON.stringify(data)}, Time: ${currentTime}</p>`;
            })
            .catch(err => console.error(err));
    });
</script>
<br>
<a href="/"> DB HOME </a>

</body>
</html>
              cableTemplate = "module";
