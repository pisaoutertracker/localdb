<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Session Results</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.20/datatables.min.css"/>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.20/datatables.min.js"></script>
    <script src="config.js"></script>
    <style>
        .container { max-width: 100%; margin: 0 auto; padding: 20px; }
        .plot-selector {
            margin: 20px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }
        .plot-image {
            max-width: 400px;
            cursor: pointer;
        }
        .plot-image:hover {
            transform: scale(1.05);
            transition: transform 0.2s;
        }
        .select-all-container {
            margin: 10px 0;
        }
        .add-plot-selector {
            margin-left: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .remove-plot-selector {
            margin-left: 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center
        }
        .plot-selectors-container {
            margin-bottom: 20px;
        }
        .plot-column {
            display: inline-block;
            margin-right: 10px;
            vertical-align: top
        }
        .plot-header {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px
        }
        .plots-container {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap; /* Prevent wrapping */
            overflow-x: auto; /* Enable horizontal scrolling */
            width: 100%; /* Take up full width */
        }
        .dataTables_wrapper {
            overflow-x: auto
        }
        #testsTable {
            width: 100% !important; /* Make the table wider */
        }
        #testsTable td:nth-child(1), /* Compare checkbox */
        #testsTable th:nth-child(1),
        #testsTable td:nth-child(2), /* Module Name */
        #testsTable th:nth-child(2),
        #testsTable td:nth-child(3), /* Test Name */
        #testsTable th:nth-child(3),
        #testsTable td:nth-child(4), /* Run (combined) */
        #testsTable th:nth-child(4),
        #testsTable td:nth-child(5), /* Noise Stats */
        #testsTable th:nth-child(5) {
            width: 15%; /* Adjust as needed */
            white-space: nowrap
        }
        .run-info {
            display: flex;
            flex-direction: column
        }
        .run-number {
            font-weight: bold
        }
        .run-date {
            font-size: 0.9em;
            color: #666
        }
        .run-type {
            font-size: 0.9em;
            color: #666;
        }
        .run-results {
            font-size: 0.9em;
            margin-top: 2px
        }
        .run-results a {
            color: #0066cc;
            text-decoration: none
        }
        .run-results a:hover {
            text-decoration: underline
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666
        }
        .error {
            background-color: #fff0f0;
            color: #c00;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #c00;
            display: none
        }
        .pass-badge {
            display: inline-block;
            padding: 2px 6px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 5px
        }
        .fail-badge {
            display: inline-block;
            padding: 2px 6px;
            background-color: #f44336;
            color: white;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 5px
        }
        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #0066cc;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer
        }
        .back-button:hover {
            background-color: #0055aa
        }
        .noise-stats {
            display: flex;
            flex-direction: column;
            gap: 5px
        }
        .noise-component {
            margin-bottom: 6px;
            border-left: 3px solid #eee;
            padding-left: 8px
        }
        .noise-component-title {
            font-weight: bold;
            margin-bottom: 2px
        }
        .noise-stat-row {
            font-size: 0.9em
        }
        .session-details {
            background-color: #f0f8ff; /* Light blue background like the banner had */
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #0066cc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .session-details h3 {
            margin-top: 0;
            color: #0066cc;
        }
        .session-details-row {
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
        }
        .session-details-label {
            font-weight: bold;
            margin-right: 10px;
            min-width: 120px;
            color: #555;
        }
        .session-details-value {
            flex: 1;
        }
        .session-description-value {
            font-style: italic;
            margin-top: 5px;
        }
        /* Remove the now-unused session banner styles */
        .session-banner, .session-banner-content, .session-info-item, 
        .session-info-label, .session-description {
            display: none;
        }
        /* Debug info style - keep it for troubleshooting */
        .debug-info {
            background-color: #ffe;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow: auto;
            display: none;
        }
        .temperature-info {
            margin-top: 4px;
            font-size: 0.85em;
            color: #333;
            display: flex;
            align-items: center;
        }
        .temperature-label {
            font-weight: bold;
            margin-right: 5px;
        }
        .temperature-value {
            color: #0066cc;
        }
        .temperature-value-unknown {
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="select_session.html" class="back-button">Back to Session Selection</a>
        <h2>Session Tests for <span id="sessionName"></span></h2>
        
        <!-- Remove the session banner -->
        
        <div id="loading" class="loading">Loading session data...</div>
        <div id="error" class="error"></div>
        
        <div id="content" style="display: none;">
            <!-- Keep only this session details section -->
            <div id="sessionDetails" class="session-details"></div>
            
            <!-- Add debug section for troubleshooting -->
            <div id="sessionDebug" class="debug-info"></div>
            
            <div class="plot-selectors-container">
                <div class="plot-selector" id="plotSelector1">
                    <div>
                        <label for="plotType1">Select Plot Type:</label>
                        <select id="plotType1" class="plot-type-select">
                            <option value="SCurve_Hybrid1_SSAMergedSSA">SCurve Hybrid1 SSAMerged</option>
                            <option value="2DPixelNoise_Hybrid0_MPAMergedMPA">2D Pixel Noise Hybrid 0 MPA Merged</option>
                            <option value="2DPixelNoise_Hybrid1_MPAMergedMPA">2D Pixel Noise Hybrid 1 MPA Merged</option>
                            <option value="2DPixelNoise_MPAMultipleMPA">2D Pixel Noise MPA Multiple</option>
                            <option value="2DPixelNoiseprojX_Hybrid0_MPAMergedMPA">2D Pixel Noise Projection X Hybrid 0 MPA Merged</option>
                            <option value="2DPixelNoiseprojX_Hybrid1_MPAMergedMPA">2D Pixel Noise Projection X Hybrid 1 MPA Merged</option>
                            <option value="2DPixelNoiseprojY_Hybrid0_MPAMergedMPA">2D Pixel Noise Projection Y Hybrid 0 MPA Merged</option>
                            <option value="2DPixelNoiseprojY_Hybrid1_MPAMergedMPA">2D Pixel Noise Projection Y Hybrid 1 MPA Merged</option>
                            <option value="BestCICinputPhases_Hybrid0">Best CIC Input Phases Hybrid 0</option>
                            <option value="BestCICinputPhases_Hybrid1">Best CIC Input Phases Hybrid 1</option>
                            <option value="BitSlipValues_Hybrid0">Bit Slip Values Hybrid 0</option>
                            <option value="BitSlipValues_Hybrid1">Bit Slip Values Hybrid 1</option>
                            <option value="ChannelNoiseDistribution_Hybrid0_MPAMergedMPA">Channel Noise Distribution Hybrid 0 MPA Merged</option>
                            <option value="ChannelNoiseDistribution_Hybrid0_SSAMergedSSA">Channel Noise Distribution Hybrid 0 SSA Merged</option>
                            <option value="ChannelNoiseDistribution_Hybrid1_MPAMergedMPA">Channel Noise Distribution Hybrid 1 MPA Merged</option>
                            <option value="ChannelNoiseDistribution_Hybrid1_SSAMergedSSA">Channel Noise Distribution Hybrid 1 SSA Merged</option>
                            <option value="ChannelNoiseDistribution_MPAMultipleMPA">Channel Noise Distribution MPA Multiple</option>
                            <option value="ChannelNoiseDistribution_SSAMultipleSSA">Channel Noise Distribution SSA Multiple</option>
                            <option value="ChannelPedestalDistribution_Hybrid0_MPAMergedMPA">Channel Pedestal Distribution Hybrid 0 MPA Merged</option>
                            <option value="ChannelPedestalDistribution_Hybrid0_SSAMergedSSA">Channel Pedestal Distribution Hybrid 0 SSA Merged</option>
                            <option value="ChannelPedestalDistribution_Hybrid1_MPAMergedMPA">Channel Pedestal Distribution Hybrid 1 MPA Merged</option>
                            <option value="ChannelPedestalDistribution_Hybrid1_SSAMergedSSA">Channel Pedestal Distribution Hybrid 1 SSA Merged</option>
                            <option value="ChannelPedestalDistribution_MPAMultipleMPA">Channel Pedestal Distribution MPA Multiple</option>
                            <option value="ChannelPedestalDistribution_SSAMultipleSSA">Channel Pedestal Distribution SSA Multiple</option>
                            <option value="CICinputPhaseHistogram_Hybrid0">CIC Input Phase Histogram Hybrid 0</option>
                            <option value="CICinputPhaseHistogram_Hybrid1">CIC Input Phase Histogram Hybrid 1</option>
                            <option value="CICwordAlignmentDelay_Hybrid0">CIC Word Alignment Delay Hybrid 0</option>
                            <option value="CICwordAlignmentDelay_Hybrid1">CIC Word Alignment Delay Hybrid 1</option>
                            <option value="CombinedNoisePlot">Combined Noise Plot</option>
                            <option value="HybridNoiseDistribution_Hybrid0">Hybrid Noise Distribution Hybrid 0</option>
                            <option value="HybridNoiseDistribution_Hybrid1">Hybrid Noise Distribution Hybrid 1</option>
                            <option value="HybridPixelNoiseDistribution_Hybrid0">Hybrid Pixel Noise Distribution Hybrid 0</option>
                            <option value="HybridPixelNoiseDistribution_Hybrid1">Hybrid Pixel Noise Distribution Hybrid 1</option>
                            <option value="HybridStripNoiseDistribution_Hybrid0">Hybrid Strip Noise Distribution Hybrid 0</option>
                            <option value="HybridStripNoiseDistribution_Hybrid1">Hybrid Strip Noise Distribution Hybrid 1</option>
                            <option value="LockingEfficiencyCICinput_Hybrid0">Locking Efficiency CIC Input Hybrid 0</option>
                            <option value="LockingEfficiencyCICinput_Hybrid1">Locking Efficiency CIC Input Hybrid 1</option>
                            <option value="LpGBTinputAlignmentSuccess_OpticalGroup1">LpGBT Input Alignment Success Optical Group 1</option>
                            <option value="LpGBTinputBestPhase_OpticalGroup1">LpGBT Input Best Phase Optical Group 1</option>
                            <option value="LpGBTinputFoundPhasesDistribution_OpticalGroup1">LpGBT Input Found Phases Distribution Optical Group 1</option>
                            <option value="NoiseDistribution_Hybrid0_MPAMergedMPA">Noise Distribution Hybrid 0 MPA Merged</option>
                            <option value="NoiseDistribution_Hybrid0_SSAMergedSSA">Noise Distribution Hybrid 0 SSA Merged</option>
                            <option value="NoiseDistribution_Hybrid1_MPAMergedMPA">Noise Distribution Hybrid 1 MPA Merged</option>
                            <option value="NoiseDistribution_Hybrid1_SSAMergedSSA">Noise Distribution Hybrid 1 SSA Merged</option>
                            <option value="NoiseDistribution_MPAMultipleMPA">Noise Distribution MPA Multiple</option>
                            <option value="NoiseDistribution_SSAMultipleSSA">Noise Distribution SSA Multiple</option>
                            <option value="OccupancyAfterOffsetEqualization_Hybrid0_MPAMergedMPA">Occupancy After Offset Equalization Hybrid 0 MPA Merged</option>
                            <option value="OccupancyAfterOffsetEqualization_Hybrid0_SSAMergedSSA">Occupancy After Offset Equalization Hybrid 0 SSA Merged</option>
                            <option value="OccupancyAfterOffsetEqualization_Hybrid1_MPAMergedMPA">Occupancy After Offset Equalization Hybrid 1 MPA Merged</option>
                            <option value="OccupancyAfterOffsetEqualization_Hybrid1_SSAMergedSSA">Occupancy After Offset Equalization Hybrid 1 SSA Merged</option>
                            <option value="OccupancyAfterOffsetEqualization_MPAMultipleMPA">Occupancy After Offset Equalization MPA Multiple</option>
                            <option value="OccupancyAfterOffsetEqualization_SSAMultipleSSA">Occupancy After Offset Equalization SSA Multiple</option>
                            <option value="Occupancy_Hybrid0_MPAMergedMPA">Occupancy Hybrid 0 MPA Merged</option>
                            <option value="Occupancy_Hybrid0_SSAMergedSSA">Occupancy Hybrid 0 SSA Merged</option>
                            <option value="Occupancy_Hybrid1_MPAMergedMPA">Occupancy Hybrid 1 MPA Merged</option>
                            <option value="Occupancy_Hybrid1_SSAMergedSSA">Occupancy Hybrid 1 SSA Merged</option>
                            <option value="Occupancy_MPAMultipleMPA">Occupancy MPA Multiple</option>
                            <option value="Occupancy_SSAMultipleSSA">Occupancy SSA Multiple</option>
                            <option value="OffsetValues_Hybrid0_MPAMergedMPA">Offset Values Hybrid 0 MPA Merged</option>
                            <option value="OffsetValues_Hybrid0_SSAMergedSSA">Offset Values Hybrid 0 SSA Merged</option>
                            <option value="OffsetValues_Hybrid1_MPAMergedMPA">Offset Values Hybrid 1 MPA Merged</option>
                            <option value="OffsetValues_Hybrid1_SSAMergedSSA">Offset Values Hybrid 1 SSA Merged</option>
                            <option value="PatternMatchingEfficiencyCIC_Hybrid0">Pattern Matching Efficiency CIC Hybrid 0</option>
                            <option value="PatternMatchingEfficiencyCIC_Hybrid1">Pattern Matching Efficiency CIC Hybrid 1</option>
                            <option value="PatternMatchingEfficiency_Hybrid0">Pattern Matching Efficiency Hybrid 0</option>
                            <option value="PatternMatchingEfficiency_Hybrid1">Pattern Matching Efficiency Hybrid 1</option>
                            <option value="PedestalDistribution_Hybrid0_MPAMergedMPA">Pedestal Distribution Hybrid 0 MPA Merged</option>
                            <option value="PedestalDistribution_Hybrid0_SSAMergedSSA">Pedestal Distribution Hybrid 0 SSA Merged</option>
                            <option value="PedestalDistribution_Hybrid1_MPAMergedMPA">Pedestal Distribution Hybrid 1 MPA Merged</option>
                            <option value="PedestalDistribution_Hybrid1_SSAMergedSSA">Pedestal Distribution Hybrid 1 SSA Merged</option>
                            <option value="PedestalDistribution_MPAMultipleMPA">Pedestal Distribution MPA Multiple</option>
                            <option value="PedestalDistribution_SSAMultipleSSA">Pedestal Distribution SSA Multiple</option>
                            <option value="SCurve_Hybrid0_MPAMergedMPA">S-Curve Hybrid 0 MPA Merged</option>
                            <option value="SCurve_Hybrid0_SSAMergedSSA">S-Curve Hybrid 0 SSA Merged</option>
                            <option value="SCurve_Hybrid1_MPAMergedMPA">S-Curve Hybrid 1 MPA Merged</option>
                            <option value="SCurve_Hybrid1_SSAMergedSSA">S-Curve Hybrid 1 SSA Merged</option>
                            <option value="sensor_data_plot">Sensor Data Plot</option>
                            <option value="VplusValue_Hybrid0_MPAMergedMPA">V+ Value Hybrid 0 MPA Merged</option>
                            <option value="VplusValue_Hybrid0_SSAMergedSSA">V+ Value Hybrid 0 SSA Merged</option>
                            <option value="VplusValue_Hybrid1_MPAMergedMPA">V+ Value Hybrid 1 MPA Merged</option>
                            <option value="VplusValue_Hybrid1_SSAMergedSSA">V+ Value Hybrid 1 SSA Merged</option>
                            <option value="WordAlignmentRetryNumbers_Hybrid0">Word Alignment Retry Numbers Hybrid 0</option>
                            <option value="WordAlignmentRetryNumbers_Hybrid1">Word Alignment Retry Numbers Hybrid 1</option>
                        </select>
                    </div>
                    <button class="add-plot-selector" title="Add another plot type">+</button>
                </div>
            </div>

            <div class="select-all-container">
                <input type="checkbox" id="selectAll">
                <label for="selectAll">Select All Tests</label>
            </div>

            <table id="testsTable" class="display">
                <thead>
                    <tr>
                        <th>Compare</th>
                        <th>Module</th>
                        <th>Test Name</th>
                        <th>Run</th>
                        <th>Noise Stats</th>
                        <th>Plots</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionName = urlParams.get('session');
            let plotSelectorCount = 1;
            
            // Cache for plot data
            const plotCache = {};
            
            if (!sessionName) {
                showError("No session name provided in URL. Please go back and select a session.");
                return;
            }
            
            $('#sessionName').text(sessionName);
            document.title = `Tests for Session: ${sessionName}`;
            
            // Add event handler for the add plot selector button
            $('.container').on('click', '.add-plot-selector', function() {
                plotSelectorCount++;
                const newSelectorId = `plotSelector${plotSelectorCount}`;
                
                // Clone the first selector
                const newSelector = $('#plotSelector1').clone();
                newSelector.attr('id', newSelectorId);
                
                // Update the select ID
                newSelector.find('select').attr('id', `plotType${plotSelectorCount}`);
                
                // Replace the add button with remove button for all but the first selector
                newSelector.find('.add-plot-selector').replaceWith(
                    `<button class="remove-plot-selector" data-selector-id="${newSelectorId}" title="Remove this plot type">-</button>`
                );
                
                // Append the new selector
                $('.plot-selectors-container').append(newSelector);
                
                // Update plots if tests are already selected
                updateAllPlots();
            });
            
            // Add event handler for remove plot selector button
            $('.container').on('click', '.remove-plot-selector', function() {
                const selectorId = $(this).data('selector-id');
                $(`#${selectorId}`).remove();
                
                // Update plots
                updateAllPlots();
            });
            
            // Fetch session data from the API endpoint
            $.ajax({
                url: `${API_BASE_URL}/fetch_session_results/${sessionName}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    $('#loading').hide();
                    
                    // Add debugging to inspect the data structure
                    console.log("Session data:", data);
                    
                    if (data && data.module_tests && data.module_tests.length > 0) {
                        // Show session banner even if we don't have detailed session info
                        displaySessionDetails(data);
                        initializeTestsTable(data);
                        $('#content').show();
                    } else {
                        showError("No tests found for this session.");
                    }
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();
                    let errorMessage = "Failed to fetch session results.";
                    
                    try {
                        // Try to parse error response if it's JSON
                        const errorData = JSON.parse(xhr.responseText);
                        if (errorData && errorData.error) {
                            errorMessage += " " + errorData.error;
                        }
                    } catch (e) {
                        // If parsing fails, use status text
                        errorMessage += " " + xhr.statusText;
                    }
                    
                    showError(errorMessage);
                }
            });
            
            function displaySessionDetails(data) {
                // Get session data from different possible locations in the response
                const sessionData = data.session || {};
                
                // For debugging - show the actual session data structure
                $('#sessionDebug').html(`<pre>${JSON.stringify(sessionData, null, 2)}</pre>`);
                
                // Try to extract operator from different possible paths
                let operator = 'N/A';
                if (sessionData.operator) {
                    operator = sessionData.operator;
                } else if (data.operator) {
                    operator = data.operator;
                } else if (data.module_tests && data.module_tests[0] && data.module_tests[0].session) {
                    operator = data.module_tests[0].session.operator || 'N/A';
                }
                
                // Try to extract timestamp from different possible paths
                let timestamp = null;
                if (sessionData.timestamp) {
                    timestamp = sessionData.timestamp;
                } else if (data.timestamp) {
                    timestamp = data.timestamp;
                } else if (data.module_tests && data.module_tests[0] && data.module_tests[0].session) {
                    timestamp = data.module_tests[0].session.timestamp;
                } else if (data.module_tests && data.module_tests[0] && data.module_tests[0].run && data.module_tests[0].run.data) {
                    timestamp = data.module_tests[0].run.data.runDate;
                }
                
                const sessionDate = timestamp ? 
                    new Date(timestamp).toLocaleString('en-GB', { 
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'N/A';
                
                // Try to extract description from different possible paths
                let description = 'N/A';
                if (sessionData.description) {
                    description = sessionData.description;
                } else if (data.description) {
                    description = data.description;
                } else if (data.module_tests && data.module_tests[0] && data.module_tests[0].session) {
                    description = data.module_tests[0].session.description || 'N/A';
                }
                
                // Populate the session details section with enhanced styling
                let detailsHTML = `
                    <h3>Session Details</h3>
                    <div class="session-details-row">
                        <span class="session-details-label">Session Name:</span>
                        <span class="session-details-value">${sessionName}</span>
                    </div>
                    <div class="session-details-row">
                        <span class="session-details-label">Operator:</span>
                        <span class="session-details-value">${operator}</span>
                    </div>
                    <div class="session-details-row">
                        <span class="session-details-label">Date:</span>
                        <span class="session-details-value">${sessionDate}</span>
                    </div>
                    <div class="session-details-row">
                        <span class="session-details-label">Description:</span>
                        <span class="session-details-value session-description-value">${description}</span>
                    </div>
                `;
                
                $('#sessionDetails').html(detailsHTML);
                
                // If a field is N/A, make it less prominent
                $('.session-details-value').each(function() {
                    if ($(this).text() === 'N/A') {
                        $(this).css('color', '#999');
                    }
                });
                
                // Show debug info on details section click if in development
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    $('#sessionDetails').click(function() {
                        $('#sessionDebug').toggle();
                    });
                }
            }
            
            function initializeTestsTable(sessionData) {
                // Process test data for DataTables
                let tableData = sessionData.module_tests.map(test => {
                    // Get module data
                    const moduleData = test.module || {};
                    
                    // Extract run number from test name (format: moduleName__runXYZ)
                    const runMatch = test.module_test_name.match(/run(\d+)/);
                    const runNumber = runMatch ? parseInt(runMatch[1]) : 0;
                    
                    // Get run data
                    const runData = test.run?.data || {};
                    
                    // Get analysis data
                    const analysisData = test.analysis || {};
                    
                    // Construct log file URL
                    let logFileUrl = null;
                    if (runData.runFile) {
                        const pathMatch = runData.runFile.match(/([^\/]+\/[^\/]+)$/);
                        if (pathMatch && pathMatch[1]) {
                            const folderName = pathMatch[1].split('/')[0]; // Extract folder name
                            logFileUrl = `https://cmstkita.web.cern.ch/Pisa/TBPS/log.html?logfile=https://cmstkita.web.cern.ch/Pisa/TBPS/navigator_eos.php/${pathMatch[1]}/${folderName}.log`;
                        }
                    }
                    
                    // Construct results URL
                    let resultsUrl = null;
                    let dqmUrl = null; // Add variable for DQM URL
                    if (runData.runFile) {
                        const pathMatch = runData.runFile.match(/([^\/]+\/[^\/]+)$/);
                        if (pathMatch && pathMatch[1]) {
                            resultsUrl = `https://cmstkita.web.cern.ch/Pisa/TBPS/root.html?file=https://cmstkita.web.cern.ch/Pisa/TBPS/navigator_eos.php/${pathMatch[1]}/Results.root`;
                            dqmUrl = `https://cmstkita.web.cern.ch/Pisa/TBPS/root.html?file=https://cmstkita.web.cern.ch/Pisa/TBPS/navigator_eos.php/${pathMatch[1]}/MonitorDQM.root`; // Construct DQM URL
                        }
                    }
                    
                    // Extract test status from analysis
                    const testStatus = analysisData.analysisResults ? 
                        analysisData.analysisResults[test.module_test_name] || 'N/A' : 'N/A';
                    
                    // Extract temperature information if available
                    const temperatures = {
                        start: analysisData.moduleTempStart !== undefined ? parseFloat(analysisData.moduleTempStart) : undefined,
                        stop: analysisData.moduleTempStop !== undefined ? parseFloat(analysisData.moduleTempStop) : undefined
                    };
                    
                    // Extract noise values
                    const noise = test.module_test_data?.noise || {};
                    
                    // Calculate average noise for both hybrids
                    const hybrid0SSAValues = [], hybrid0MPAValues = [];
                    const hybrid1SSAValues = [], hybrid1MPAValues = [];
                    
                    Object.entries(noise).forEach(([key, value]) => {
                        if (key.startsWith('H0_SSA')) hybrid0SSAValues.push(value);
                        else if (key.startsWith('H0_MPA')) hybrid0MPAValues.push(value);
                        else if (key.startsWith('H1_SSA')) hybrid1SSAValues.push(value);
                        else if (key.startsWith('H1_MPA')) hybrid1MPAValues.push(value);
                    });
                    
                    const calcAvg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
                    const calcMax = arr => arr.length ? Math.max(...(arr)) : 0;
                    const calcMin = arr => arr.length ? Math.min(...arr) : 0;
                    
                    // Updated noise stats to split by component type
                    const noiseStats = {
                        ssa: {
                            hybrid0: {
                                avg: calcAvg(hybrid0SSAValues),
                                max: calcMax(hybrid0SSAValues),
                                min: calcMin(hybrid0SSAValues)
                            },
                            hybrid1: {
                                avg: calcAvg(hybrid1SSAValues),
                                max: calcMax(hybrid1SSAValues),
                                min: calcMin(hybrid1SSAValues)
                            },
                            overall: {
                                avg: calcAvg([...hybrid0SSAValues, ...hybrid1SSAValues]),
                                max: calcMax([...hybrid0SSAValues, ...hybrid1SSAValues]),
                                min: calcMin([...hybrid0SSAValues, ...hybrid1SSAValues])
                            }
                        },
                        mpa: {
                            hybrid0: {
                                avg: calcAvg(hybrid0MPAValues),
                                max: calcMax(hybrid0MPAValues),
                                min: calcMin(hybrid0MPAValues)
                            },
                            hybrid1: {
                                avg: calcAvg(hybrid1MPAValues),
                                max: calcMax(hybrid1MPAValues),
                                min: calcMin(hybrid1MPAValues)
                            },
                            overall: {
                                avg: calcAvg([...hybrid0MPAValues, ...hybrid1MPAValues]),
                                max: calcMax([...hybrid0MPAValues, ...hybrid1MPAValues]),
                                min: calcMin([...hybrid0MPAValues, ...hybrid1MPAValues])
                            }
                        },
                        overall: {
                            avg: calcAvg([...hybrid0SSAValues, ...hybrid0MPAValues, ...hybrid1SSAValues, ...hybrid1MPAValues]),
                            max: calcMax([...hybrid0SSAValues, ...hybrid0MPAValues, ...hybrid1SSAValues, ...hybrid1MPAValues]),
                            min: calcMin([...hybrid0SSAValues, ...hybrid0MPAValues, ...hybrid1SSAValues, ...hybrid1MPAValues])
                        }
                    };
                    
                    // Store analysis file URL in plot cache for later use
                    if (analysisData.analysisFile) {
                        plotCache[test.module_test_name] = analysisData.analysisFile;
                    }
                    
                    return {
                        checkbox: '',
                        moduleName: moduleData.moduleName || 'N/A',
                        name: test.module_test_name,
                        status: testStatus,
                        temperatures: temperatures,
                        runNumber: runNumber, // Keep this as a sortable value
                        runDateTimestamp: runData.runDate ? new Date(runData.runDate).getTime() : 0,
                        runDate: runData.runDate ? new Date(runData.runDate).toLocaleString('en-GB', { 
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        }) : 'N/A',
                        combinedRunInfo: { // Combined field for display
                            number: runNumber,
                            date: runData.runDate ? new Date(runData.runDate).toLocaleString('en-GB', { 
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            }) : 'N/A',
                            resultsUrl: resultsUrl,
                            dqmUrl: dqmUrl, // Add dqmUrl here
                            logFileUrl: logFileUrl,
                            runType: runData.runType || 'N/A'
                        },
                        analysisFile: analysisData.analysisFile || null,
                        noise: noiseStats,
                        plots: ''
                    };
                });
                
                // Initialize DataTable
                var table = $('#testsTable').DataTable({
                    data: tableData,
                    pageLength: 25, // Set default display length to 25
                    columns: [
                        { 
                            data: 'checkbox',
                            render: function(data, type, row) {
                                return '<input type="checkbox" class="test-checkbox">';
                            },
                            orderable: false
                        },
                        { 
                            data: 'moduleName',
                            render: function(data, type, row) {
                                // Create a link to the module view
                                return `<a href="module_results.html?module=${encodeURIComponent(data)}" class="module-link">
                                          <span class="module-name">${data}</span>
                                        </a>`;
                            }
                        },
                        { 
                            data: 'name',
                            render: function(data, type, row) {
                                const analysisFile = row.analysisFile || '#';
                                let html = `<a href="${analysisFile}" target="_blank" class="clickable">${data}</a>`;
                                
                                if (row.status.toLowerCase() === 'pass') {
                                    html += `<span class="pass-badge">PASS</span>`;
                                } else if (row.status.toLowerCase() === 'failed') {
                                    html += `<span class="fail-badge">FAIL</span>`;
                                }
                                
                                // Update the temperature display in the render function for the test name column
                                if (row.temperatures && (row.temperatures.start !== undefined || row.temperatures.stop !== undefined)) {
                                    const startTemp = row.temperatures.start !== undefined ? 
                                        row.temperatures.start.toFixed(2) + ' °C' : 'N/A';
                                    const stopTemp = row.temperatures.stop !== undefined ? 
                                        row.temperatures.stop.toFixed(2) + ' °C' : 'N/A';
                                    
                                    html += `<div class="temperature-info">
                                                <span class="temperature-label">Temp:</span>
                                                <span class="temperature-value">${startTemp} to ${stopTemp}</span>
                                            </div>`;
                                } else {
                                    html += `<div class="temperature-info">
                                                <span class="temperature-label">Temp:</span>
                                                <span class="temperature-value-unknown">unknown</span>
                                            </div>`;
                                }
                                
                                return html;
                            }
                        },
                        { 
                            data: 'runDateTimestamp', // Use runDateTimestamp for sorting instead of runNumber
                            render: function(data, type, row) {
                                if (type === 'sort' || type === 'type') {
                                    return data; // Use run number for sorting
                                }
                                
                                // For display, combine run number, date, and results link
                                let html = `<div class="run-info">
                                              <span class="run-number">#${row.combinedRunInfo.number}</span>
                                              <span class="run-date">${row.combinedRunInfo.date}</span>`;
                                
                                // Add results link if available
                                if (row.combinedRunInfo.resultsUrl) {
                                    html += `<span class="run-results">
                                               <a href="${row.combinedRunInfo.resultsUrl}" target="_blank">Read ROOT File</a>
                                             </span>`;
                                }
                                
                                // Add DQM link if available
                                if (row.combinedRunInfo.dqmUrl) {
                                    html += `<span class="run-results">
                                               <a href="${row.combinedRunInfo.dqmUrl}" target="_blank">Read DQM File</a>
                                             </span>`;
                                }
                                
                                // Add log file link if available
                                if (row.combinedRunInfo.logFileUrl) {
                                    html += `<span class="run-results">
                                               <a href="${row.combinedRunInfo.logFileUrl}" target="_blank">Read Log File</a>
                                             </span>`;
                                }
                                // add run type if available
                                if (row.combinedRunInfo.runType) {
                                    html += `<span class="run-type">Type: ${row.combinedRunInfo.runType}</span>`;
                                }
                                html += `</div>`;
                                return html;
                            }
                        },
                        { 
                            data: 'noise',
                            render: function(data, type, row) {
                                if (type === 'sort' || type === 'type') {
                                    return data.overall.avg; // Sort by overall average
                                }
                                
                                // Display noise statistics by component
                                return `<div class="noise-stats">
                                          <div class="noise-component">
                                            <div class="noise-component-title">SSA:</div>
                                            <div class="noise-stat-row">Avg: ${data.ssa.overall.avg.toFixed(3)}</div>
                                            <div class="noise-stat-row">Max: ${data.ssa.overall.max.toFixed(3)}</div>
                                            <div class="noise-stat-row">Min: ${data.ssa.overall.min.toFixed(3)}</div>
                                          </div>
                                          <div class="noise-component">
                                            <div class="noise-component-title">MPA:</div>
                                            <div class="noise-stat-row">Avg: ${data.mpa.overall.avg.toFixed(3)}</div>
                                            <div class="noise-stat-row">Max: ${data.mpa.overall.max.toFixed(3)}</div>
                                            <div class="noise-stat-row">Min: ${data.mpa.overall.min.toFixed(3)}</div>
                                          </div>
                                        </div>`;
                            }
                        },
                        { 
                            data: 'plots',
                            render: function() { 
                                return '<div class="plots-container"></div>'; 
                            },
                            orderable: false
                        }
                    ],
                    order: [[3, 'desc']], // Sort by run number descending by default
                    drawCallback: function(settings) {
                        // Adjust column widths after table is drawn
                        this.api().columns.adjust();
                    }
                });

                // Handle checkbox changes
                $('#testsTable').on('change', '.test-checkbox', function() {
                    const row = table.row($(this).closest('tr'));
                    const testName = row.data().name;
                    updatePlots(row, this.checked);
                });

                // Handle select all
                $('#selectAll').on('change', function() {
                    $('.test-checkbox').prop('checked', this.checked).trigger('change');
                });
                
                // Handle plot type changes
                $('.container').on('change', '.plot-type-select', function() {
                    updateAllPlots();
                });
            }
            
            function showError(message) {
                $('#error').text(message).show();
                $('#loading').hide();
            }
            
            function updateAllPlots() {
                $('.test-checkbox:checked').each(function() {
                    const row = $('#testsTable').DataTable().row($(this).closest('tr'));
                    updatePlots(row, true);
                });
            }

            function updatePlots(row, show) {
                const testName = row.data().name;
                const plotsContainer = $(row.node()).find('.plots-container');
                
                if (!show) {
                    plotsContainer.empty();
                    return;
                }

                // Clear existing plots
                plotsContainer.empty();
                
                // Get cached analysis file URL
                const analysisFile = plotCache[testName];
                
                if (!analysisFile) {
                    plotsContainer.html('<p>No plot data available</p>');
                    return;
                }
                
                // Display plots using the cached URL
                displayPlots(testName, analysisFile, plotsContainer);
            }
            
            function displayPlots(testName, analysisFile, plotsContainer) {
                // Create a column for each plot type
                $('.plot-type-select').each(function() {
                    const plotType = $(this).val();
                    const plotName = $(this).find('option:selected').text();
                    
                    const plotUrl = `${analysisFile}${plotType}.png`;
                    const plotColumn = $('<div class="plot-column"></div>');
                    plotColumn.attr('data-plot-type', plotType);
                    
                    plotColumn.html(`
                        <div class="plot-header">${plotName}</div>
                        <img class="plot-image" src="${plotUrl}" alt="${testName} - ${plotName}" 
                             onerror="this.onerror=null;this.src='';this.alt='Plot not available';this.style.height='200px';this.style.width='300px';this.style.backgroundColor='#f5f5f5';this.style.display='flex';this.style.alignItems='center';this.style.justifyContent='center';">
                    `);
                    
                    plotsContainer.append(plotColumn);
                });
                
                // Make plot images clickable to open in a new tab
                plotsContainer.on('click', '.plot-image', function() {
                    const src = $(this).attr('src');
                    if (src && src !== '') {
                        window.open(src, '_blank');
                    }
                });
                
                // Adjust the table width to accommodate all plots
                $('#testsTable').DataTable().columns.adjust();
                
                // Show a separator between tests for clarity
                plotsContainer.parent().css('border-bottom', '1px solid #ddd');
            }
        });
    </script>
</body>
</html>