<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Module Inventory</title>
  <style>
    :root{
      --bg:#f4f7fb;--card:#ffffff;--muted:#6b7280;--accent:#2563eb;--border:#e6eefc;--surface:#f8fafc
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:Inter,ui-sans-serif,system-ui,Arial,Helvetica,sans-serif;background:var(--bg);color:#0f172a;margin:0;padding:18px;height:100%}
  /* limit container to viewport height so page never grows beyond screen */
  .container{width:100%;max-width:none;margin:0 auto;padding:18px 24px;background:linear-gradient(180deg,rgba(255,255,255,0.8),rgba(255,255,255,0.95));border-radius:10px;box-shadow:0 6px 20px rgba(14,30,37,0.08);border:1px solid rgba(15,23,42,0.04);height:calc(100vh - 36px);display:flex;flex-direction:column;overflow:hidden}
    h1{margin:0 0 8px;font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    .filters{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0 18px}
    .filters label{font-size:13px;color:#0f172a;display:flex;align-items:center;gap:8px;background:var(--surface);padding:6px 8px;border-radius:8px;border:1px solid var(--border)}
    .filters select,.filters input{padding:6px;border-radius:6px;border:1px solid #dbeafe;background:white}
    .layout{display:flex;gap:16px;flex:1;align-items:stretch}
  /* table-wrap scrolls internally and is capped to the remaining viewport height */
  .table-wrap{flex:1;min-height:0;overflow:auto;overflow-x:auto;border-radius:8px;border:1px solid var(--border);background:linear-gradient(180deg,#fff,#fbfdff);width:100%;max-height:calc(100vh - 220px);position:relative}
  table{width:100%;min-width:1100px;border-collapse:collapse;font-size:13px}
  thead th[data-col]{cursor:pointer;user-select:none;position:relative;padding-right:18px}
  thead th[data-col]::after{content:'';position:absolute;right:6px;top:50%;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;margin-top:-6px;opacity:0.25}
  thead th.sorted-asc::after{border-bottom:8px solid #0b5ed7;opacity:1}
  thead th.sorted-desc::after{border-top:8px solid #0b5ed7;opacity:1}
  thead th{position:sticky;top:0;background:linear-gradient(180deg,#f8fbff,#f1f7ff);padding:10px;border-bottom:1px solid var(--border);text-align:left;z-index:2}
    tbody tr:nth-child(odd){background:transparent}
    tbody tr{border-bottom:1px solid #f1f5f9}
    td{padding:10px;vertical-align:middle}
  td.name{font-weight:600;color:#0b5ed7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px}
  table td, table th{white-space:nowrap}
  .details{width:460px;padding:14px;border-radius:8px;background:#ffffff;border:1px solid var(--border);box-shadow:0 4px 12px rgba(2,6,23,0.04);display:flex;flex-direction:column;min-height:0;max-height:calc(100vh - 120px)}
  /* keep JSON details from exceeding container height; pin buttons to bottom */
  #detail-content{display:flex;flex-direction:column;gap:8px;flex:1;min-height:0}
  #detail-json{background:#ffffff;color:#0f172a;padding:12px;border-radius:6px;overflow:auto;overflow-y:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;flex:1;min-height:0;max-height:calc(100vh - 340px)}
    #detail-editor{width:100%;height:260px;margin-top:8px;border-radius:6px;border:1px solid #e6eefc;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;display:none}
    .buttons{display:flex;gap:8px;margin-top:12px}
    button{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer;font-weight:600}
    button.secondary{background:#e6eefc;color:#0b4dd9}
    button.ghost{background:transparent;border:1px solid #e6eefc;color:#0b4dd9}
    button:disabled{opacity:.6;cursor:not-allowed}
    .small{font-size:12px;padding:6px 8px}
  /* JSON tree viewer/editor styles */
  .jt-node{margin:4px 0}
  .jt-children{margin-left:14px;padding-left:6px;border-left:1px dashed #e6eefc}
  details summary{cursor:pointer;font-weight:600;padding:6px 0}
  .jt-leaf{display:flex;gap:8px;align-items:center;padding:4px 0}
  .jt-key{color:#0b5ed7;min-width:120px}
  .jt-value{color:#0f172a}
  .jt-input{padding:4px 6px;border:1px solid #e6eefc;border-radius:6px}
  .pos-link{color:#0b5ed7;text-decoration:none;font-weight:600}
  .pos-link:hover{text-decoration:underline}
  tbody tr.selected{background:#eef6ff}
  tbody tr:hover{background:#f8fbff}
  </style>
</head>
<body>
  <div class="container">

    <div class="filters">
      <label>Layer type:
        <select id="filter-layer"><option value="any">any</option></select>
      </label>
      <label>Center:
        <select id="filter-center"><option value="any">any</option><option selected>Pisa</option></select>
      </label>
      <label>Speed:
        <select id="filter-speed"><option value="any">any</option><option>10G</option><option>5G</option></select>
      </label>
      <label>Spacer:
        <select id="filter-spacer"><option value="any">any</option></select>
      </label>
      <label>Status:
        <select id="filter-status"><option value="any">any</option><option>MOUNTED</option><option>DISCONNECTED</option></select>
      </label>
      <label>Search:
        <input id="search" placeholder="Search modules..." />
      </label>
    </div>

    <div class="layout">
      <div class="table-wrap">
        <table id="modules-table">
          <thead>
            <tr>
              <th data-col="name">Name</th>
              <th data-col="speed">Speed</th>
              <th data-col="spacer">Spacer</th>
              <th data-col="status">Status</th>
              <th data-col="connections">Connections</th>
              <th data-col="position">Position</th>
              <th data-col="description">Description</th>
              <th data-col="mounted">Mounted</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="details" id="details-panel">
        <h2 id="detail-title">Select a module</h2>
        <div id="detail-content" style="display:flex;flex-direction:column;gap:8px;flex:1;min-height:0">
          <div id="detail-json">{}</div>
        </div>
        <div class="buttons">
          <button id="edit-selected">Edit Selected</button>
          <button id="save-changes">Save Changes</button>
          <button id="disconnect">Disconnect</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let isEditing = false;
    const GENERIC_QUERY_URL = `${window.location.origin}/generic_module_query`;

    async function postGenericQuery(query, projection){
      const body = { query: query || {} };
      if (projection !== undefined) body.projection = projection;
      try{
        const res = await fetch(GENERIC_QUERY_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!res.ok) throw new Error('generic query failed');
        return await res.json();
      }catch(e){
        // fallback: return full modules list or single module depending on query
        if (query && query.moduleName){
          const resp = await fetch('/modules/' + encodeURIComponent(query.moduleName));
          if (!resp.ok) throw e;
          return await resp.json();
        }
        const resp = await fetch('/modules');
        if (!resp.ok) throw e;
        return await resp.json();
      }
    }

    // Render a nested tree viewer (and editor when editable) into container.
    function renderJsonTree(container, obj, editable = false){
      container.innerHTML = '';
      function makeNode(key, value, path){
        const wrapper = document.createElement('div');
        wrapper.className = 'jt-node';
        if (value !== null && typeof value === 'object'){
          const details = document.createElement('details');
          details.open = false;
          const summary = document.createElement('summary');
          summary.textContent = key === null ? (Array.isArray(value) ? '[array]' : '[object]') : key;
          details.appendChild(summary);
          const inner = document.createElement('div');
          inner.className = 'jt-children';
          if (Array.isArray(value)){
            value.forEach((v,i)=>{
              inner.appendChild(makeNode(String(i), v, path ? path + '.' + i : String(i)));
            });
          }else{
            Object.keys(value).forEach(k=>{
              inner.appendChild(makeNode(k, value[k], path ? path + '.' + k : k));
            });
          }
          details.appendChild(inner);
          wrapper.appendChild(details);
        }else{
          const row = document.createElement('div');
          row.className = 'jt-leaf';
          const kspan = document.createElement('span');
          kspan.className = 'jt-key';
          kspan.textContent = key;
          row.appendChild(kspan);
          if (editable){
            const inp = document.createElement('input');
            inp.className = 'jt-input';
            inp.setAttribute('data-path', path);
            inp.value = value === null ? '' : String(value);
            inp.setAttribute('data-type', value === null ? 'null' : typeof value);
            row.appendChild(inp);
          }else{
            const vspan = document.createElement('span');
            vspan.className = 'jt-value';
            vspan.textContent = value === null ? 'null' : String(value);
            row.appendChild(vspan);
          }
          wrapper.appendChild(row);
        }
        return wrapper;
      }

      // root
      if (obj !== null && typeof obj === 'object'){
        if (Array.isArray(obj)){
          obj.forEach((v,i)=> container.appendChild(makeNode(String(i), v, String(i))));
        }else{
          Object.keys(obj).forEach(k=> container.appendChild(makeNode(k, obj[k], k)));
        }
      }else{
        container.textContent = String(obj);
      }
    }

    // Read back edited values from inputs in container and rebuild object
    function readJsonFromTree(container, original){
      const inputs = container.querySelectorAll('input.jt-input');
      // start with deep clone of original to preserve structure and types
      const result = Array.isArray(original) ? [] : {};
      function setByPath(root, path, val, type){
        const parts = path.split('.');
        let cur = root;
        for (let i=0;i<parts.length-1;i++){
          const p = parts[i];
          const next = parts[i+1];
          const isIndex = !isNaN(Number(next));
          if (!(p in cur)) cur[p] = isIndex ? [] : {};
          cur = cur[p];
        }
        const last = parts[parts.length-1];
        // convert to original type
        let finalVal = val;
        if (type === 'number'){
          const n = Number(val);
          finalVal = isNaN(n) ? val : n;
        }else if (type === 'boolean'){
          finalVal = (val === 'true' || val === true);
        }else if (type === 'null'){
          finalVal = null;
        }
        cur[last] = finalVal;
      }
      inputs.forEach(inp=>{
        const path = inp.getAttribute('data-path');
        const type = inp.getAttribute('data-type');
        setByPath(result, path, inp.value, type);
      });
      return result;
    }
    // Layers config (same mapping used for filter choices)
    // spacer token values are '16','26','40' (representing 1.6mm, 2.6mm, 4.0mm)
    const layers_to_filters = {
      "L1_47": {"spacer":"26","speed":"10G"},
      "L1_60": {"spacer":"40","speed":"10G"},
      "L1_72": {"spacer":"40","speed":"10G"},
      "L2_40": {"spacer":"26","speed":"10G"},
      "L2_55": {"spacer":"26","speed":"10G"},
      "L2_68": {"spacer":"40","speed":"10G"},
      "L3": {"spacer":"26","speed":"5G"}
    };

    function spacerTokenToLabel(token){
      if (!token) return '';
      const map = { '16': '1.6mm', '26': '2.6mm', '40': '4.0mm' };
      return token + (map[token] ? (' ('+map[token]+')') : '');
    }

    function populateFilters(){
      const layerSelect = $('filter-layer');
      layerSelect.innerHTML = '<option value="any">any</option>' + Object.keys(layers_to_filters).map(k=>`<option>${k}</option>`).join('');
      const spacers = new Set(Object.values(layers_to_filters).map(x=>x.spacer));
      const spSel = $('filter-spacer');
      if (spSel) {
        const opts = ['<option value="any">any</option>'];
        [...spacers].forEach(s => opts.push(`<option value="${s}">${spacerTokenToLabel(s)}</option>`));
        spSel.innerHTML = opts.join('');
      }
    }

    // Sorting state
    let sortCol = 'name';
    let sortDir = 'asc'; // 'asc' or 'desc'

    function compareRows(a,b){
      // a and b are module objects; use spacer token and speed computed
      const get = (m, col) => {
        if (col === 'name') return (m.moduleName||'').toLowerCase();
        if (col === 'speed') return (m.speed||'').toLowerCase();
        if (col === 'spacer') return computeSpacerToken(m.moduleName||m.module||'') || '';
        if (col === 'status') return (m.status||'').toLowerCase();
        if (col === 'connections') return (JSON.stringify(m.crateSide||m.connections||'')||'').toLowerCase();
        if (col === 'position') return (m.position||'').toLowerCase();
        if (col === 'description') return (m.description||'').toLowerCase();
        if (col === 'mounted') return String(m.mounted||'').toLowerCase();
        return '';
      };
      const A = get(a, sortCol);
      const B = get(b, sortCol);
      if (A < B) return sortDir === 'asc' ? -1 : 1;
      if (A > B) return sortDir === 'asc' ? 1 : -1;
      return 0;
    }

    // data store
    let modules = [];

    function $(id){ return document.getElementById(id); }

    function computeModuleSpeed(module){
      let module_speed = "";
      const name = module.moduleName || "";
      if (name.includes("_5_") || name.includes("_05_") || name.includes("_5-") || name.includes("_05-")) module_speed = "5G";
      if (name.includes("_10_") || name.includes("_10-")) module_speed = "10G";
      try{
          // try deep children object first (full document)
          if (module.children && typeof module.children === 'object'){
            const roh = module.children["PS Read-out Hybrid"];
            if (roh && roh.details && roh.details.ALPGBT_BANDWIDTH){
              module_speed = roh.details.ALPGBT_BANDWIDTH === '10Gbps' ? '10G' : (roh.details.ALPGBT_BANDWIDTH === '5Gbps' ? '5G' : roh.details.ALPGBT_BANDWIDTH);
            }
          }
          // fallback: check for projected path flattened into document (some Mongo drivers keep nested fields accessible via dotted keys)
          const projected_bw = module?.['children.PS Read-out Hybrid.details.ALPGBT_BANDWIDTH'] || module?.['children.PS Read-out Hybrid.details']?.ALPGBT_BANDWIDTH;
          if (projected_bw){
            module_speed = projected_bw === '10Gbps' ? '10G' : (projected_bw === '5Gbps' ? '5G' : projected_bw);
          }
      }catch(e){/* ignore */}
      module.speed = module_speed || module.speed || "";
      return module.speed;
    }

    // Compute spacer token ('16','26','40') from a module name without mutating module
    function computeSpacerToken(name){
      const n = (name || '') + '';
      // look for tokens like _26_, _26- , PS_26, PS26, etc.
      if (/\b26\b|_26_|_26-|26-|26_/.test(n)) return '26';
      if (/\b40\b|_40_|_40-|40-|40_/.test(n)) return '40';
      if (/\b16\b|_16_|_16-|16-|16_/.test(n)) return '16';
      // loose checks
      if (/26/.test(n)) return '26';
      if (/40/.test(n)) return '40';
      if (/16/.test(n)) return '16';
      return '';
    }

    function renderTable(){
      const tbody = document.querySelector('#modules-table tbody');
      tbody.innerHTML = '';
      const q = $('search').value.toLowerCase();
      const layer = $('filter-layer').value;
      const speedF = $('filter-speed').value;
      const spacerF = $('filter-spacer').value;
      const statusF = $('filter-status').value;
      const centerF = $('filter-center') ? $('filter-center').value : 'any';
      // build filtered list first
      const filtered = [];
      modules.forEach((m,idx)=>{
        computeModuleSpeed(m);
        const spacerToken = computeSpacerToken(m.moduleName || m.module || '');
        if (q && !(m.moduleName||'').toLowerCase().includes(q)) return;
        if (centerF !== 'any'){
          const centerVal = (m['Current Center'] || m['CurrentCenter'] || m.currentCenter || '') + '';
          if (!centerVal.includes(centerF)) return;
        }
        if (speedF !== 'any' && speedF && m.speed !== speedF) return;
        if (spacerF !== 'any' && spacerF){
          if ((spacerToken || '') !== spacerF) return;
        }
        if (statusF !== 'any' && statusF && (m.status||'') !== statusF) return;
        filtered.push({ m, idx, spacerToken });
      });

      // sort filtered rows
      filtered.sort((a,b) => compareRows(a.m, b.m));

      // render rows
      filtered.forEach(({m, idx, spacerToken}) => {
        const tr = document.createElement('tr');
        // render connections as plain text instead of a button

        let connText = '';
        if (m?.crateSide){

          const csConns = m.crateSide || m['crateSide'];
          if (csConns){
            if (Array.isArray(csConns)) connText = csConns.join(', ');
            else if (typeof csConns === 'object') connText = JSON.stringify(csConns);
            else connText = String(csConns);
          } else if (typeof m.crateSide === 'object'){
            // crateSide is a mapping of ports to [name, num] arrays (your example)
            try{
              const parts = Object.values(m.crateSide).map(v=>{
                if (Array.isArray(v)) return v.join('/');
                if (typeof v === 'string' || typeof v === 'number') return String(v);
                return JSON.stringify(v);
              });
              connText = parts.join(', ');
            }catch(e){ connText = JSON.stringify(m.crateSide); }
          }
        }
        // crateSide is authoritative; format mapping entries as 'key:value/num' (e.g. '1:E10/9')
        if (m?.crateSide && typeof m.crateSide === 'object'){
          try{
            const parts = Object.entries(m.crateSide).map(([k,v])=>{
              if (Array.isArray(v)) return `${k}:${v.join('/')}`;
              if (typeof v === 'string' || typeof v === 'number') return `${k}:${v}`;
              return `${k}:${JSON.stringify(v)}`;
            });
            connText = parts.join(', ');
          }catch(e){ connText = JSON.stringify(m.crateSide); }
        }
        // position: if it contains exactly two semicolons (three fields), render as link
        const pos = m.position || '';
        let posHtml = pos;
        if ((pos.match(/;/g)||[]).length === 2){
          posHtml = `<a href="#" class="pos-link" data-pos="${pos}">${pos}</a>`;
        }
  tr.innerHTML = `<td class="name" title="${(m.moduleName||'').replace(/"/g,'&quot;')}">${m.moduleName || ''}</td><td>${m.speed||''}</td><td>${spacerToken ? spacerTokenToLabel(spacerToken) : ''}</td><td>${m.status||''}</td><td>${connText||''}</td><td>${posHtml||''}</td><td>${m.description||''}</td><td>${m.mounted||''}</td>`;
        tr.addEventListener('click',()=>{ try{ selectModule(idx); highlightRow(idx); }catch(e){ console.error(e); } });
        // attach click handler for position link (stop propagation so row click isn't triggered)
        setTimeout(()=>{
          const link = tr.querySelector('.pos-link');
          if (link){
            link.addEventListener('click',(ev)=>{ ev.preventDefault(); ev.stopPropagation(); const p = link.getAttribute('data-pos'); window.location = '/static/storage.html?position=' + encodeURIComponent(p); });
          }
        },0);
        tbody.appendChild(tr);
      });
    }

    let selectedIndex = null;
    async function selectModule(idx){
      selectedIndex = idx;
      let m = modules[idx];
      // if this is a lightweight row, fetch full details
      if (m && m._light){
        try{
          // prefer generic query to fetch full document
          const results = await postGenericQuery({ moduleName: m.moduleName });
          m = Array.isArray(results) ? results[0] : results;
          if (!m) {
            const resp = await fetch('/modules/' + encodeURIComponent(m.moduleName));
            m = await resp.json();
          }
          modules[idx] = m; // replace with full object
        }catch(e){ console.error('Failed to fetch full module', e); }
      }
      $('detail-title').textContent = (m && m.moduleName) ? m.moduleName : 'Module';
      const container = $('detail-json');
      // render read-only tree view
      renderJsonTree(container, m || {}, false);
      isEditing = false;
      const editBtn = $('edit-selected'); if (editBtn) editBtn.textContent = 'Edit Selected';
    }

    function attachEvents(){
      // make table headers sortable
      const headers = document.querySelectorAll('#modules-table thead th[data-col]');
      headers.forEach(h => {
        h.addEventListener('click', () => {
          const col = h.getAttribute('data-col');
          if (sortCol === col) sortDir = (sortDir === 'asc' ? 'desc' : 'asc');
          else { sortCol = col; sortDir = 'asc'; }
          // update header classes
          headers.forEach(h2 => h2.classList.remove('sorted-asc','sorted-desc'));
          h.classList.add(sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
          renderTable();
        });
      });
      // When a layer is selected, set the speed and spacer filters according to mapping
      $("filter-layer").addEventListener('change', (e) => {
        const val = e.target.value;
        if (val && val !== 'any' && layers_to_filters[val]){
          const mapping = layers_to_filters[val];
          // set speed and spacer selects to mapping values if present
          const speedSel = $('filter-speed');
          const spacerSel = $('filter-spacer');
          if (mapping.speed && speedSel){ speedSel.value = mapping.speed; }
          if (mapping.spacer && spacerSel){ spacerSel.value = mapping.spacer; }
        }
        // re-render table after adjusting filters
        renderTable();
      });
      // other filters just re-render
      ['filter-speed','filter-spacer','filter-status','filter-center'].forEach(id=>$(id).addEventListener('change',renderTable));
      $('search').addEventListener('input',renderTable);

      // Edit selected toggles an in-place JSON editor (textarea)
      $('edit-selected').addEventListener('click',async()=>{
        if (selectedIndex==null) return alert('Select a module first');
        const container = $('detail-json');
        if (!isEditing){
          renderJsonTree(container, modules[selectedIndex], true);
          isEditing = true;
          $('edit-selected').textContent = 'Cancel Edit';
        }else{
          renderJsonTree(container, modules[selectedIndex], false);
          isEditing = false;
          $('edit-selected').textContent = 'Edit Selected';
        }
      });

      // Save changes uses the textarea content when in edit mode, then PUTs to server if _id present
      $('save-changes').addEventListener('click',async()=>{
        if (selectedIndex==null) return alert('Select a module first');
        let m = modules[selectedIndex];
        if (isEditing){
          try{
            const container = $('detail-json');
            const parsed = readJsonFromTree(container, modules[selectedIndex]);
            modules[selectedIndex] = parsed;
            m = parsed;
            // switch back to view mode showing saved data
            renderJsonTree(container, m, false);
            isEditing = false;
            const editBtn = $('edit-selected'); if (editBtn) editBtn.textContent = 'Edit Selected';
            selectModule(selectedIndex);
            renderTable();
          }catch(e){ return alert('Invalid JSON from tree editor: '+e.message); }
        }
        if (!m._id){ return alert('Module has no _id — server-side save requires an identifier'); }
        try{
          const res = await fetch('/modules/' + encodeURIComponent(m._id), {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(m)});
          if (!res.ok) throw new Error('Status '+res.status);
          alert('Saved');
          loadData();
        }catch(e){alert('Save failed: '+e.message)}
      });

      $('disconnect').addEventListener('click',()=>{
        if (selectedIndex==null) return alert('Select a module first');
        modules[selectedIndex].status = modules[selectedIndex].status === 'MOUNTED' ? '' : 'MOUNTED';
        renderTable();
      });
    }

    async function loadData(){
      try{
        // load only the minimal fields for the table to improve performance
  const tableFields = { moduleName: 1, speed: 1, status: 1, connections: 1, crateSide: 1, position: 1, description: 1, mounted: 1, "children.PS Read-out Hybrid.details.ALPGBT_BANDWIDTH": 1, "Current Center": 1, CurrentCenter: 1, currentCenter: 1 };
        const data = await postGenericQuery({}, tableFields);
        // expect an array — if wrapped, try to extract
        const tableRows = Array.isArray(data) ? data : (Array.isArray(data.result) ? data.result : []);
        // store lightweight refs; full module details will be fetched when needed
        modules = tableRows.map(r => ({ _light: true, ...r }));
        populateFilters();
  renderTable();
  // auto-select first rendered row if any (respecting filters)
  const tbody = document.querySelector('#modules-table tbody');
  if (tbody && tbody.children.length>0){ try{ selectModule(0); highlightRow(0); }catch(e){console.error(e);} }
      }catch(e){
        console.error(e);
        document.querySelector('#modules-table tbody').innerHTML = '<tr><td colspan="9">Failed to load modules: '+e.message+'</td></tr>';
      }
    }

    function highlightRow(idx){
      const tbody = document.querySelector('#modules-table tbody');
      Array.from(tbody.children).forEach((tr,i)=> tr.classList.toggle('selected', i===idx));
    }

    // bootstrap
    populateFilters();
    attachEvents();
    loadData();
  </script>
</body>
</html>
