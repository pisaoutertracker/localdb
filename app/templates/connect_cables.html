<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .box {
            border: 2px solid #000;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .detbox {
            border: 2px solid #000;
            padding: 10px;
            width: 200px; /* adjust as needed */
            height: 200px; /* adjust as needed */
            background-color:  #666666;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .cratebox {
            border: 2px solid #000;
            padding: 10px;
            width: 200px; /* adjust as needed */
            height: 200px; /* adjust as needed */
            background-color: #ff0000; /* red */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        select {
            margin-top: 10px;
            padding: 5px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
<h1>Connect Cables</h1>

    <form id="connectForm">
        <div class="container">
            <div class="detbox">
                <label for="cableSelectDet">Cable DetSide:</label>
                <input list="cableSelectDetList" id="cableSelectDet" name="cableSelectDet" placeholder="Select a cable">
                <datalist id="cableSelectDetList"></datalist>
            </div>
            <div class="box">
                <label for="portSelectDet">Port:</label>
                <select id="portSelectDet"></select>
            </div>
            <div class="box">
                <label for="portSelectCrate">Port:</label>
                <select id="portSelectCrate"></select>
            </div>
            <div class="cratebox">
                <label for="cableSelectCrate">Cable CrateSide:</label>
                <input list="cableSelectCrateList" id="cableSelectCrate" name="cableSelectCrate" placeholder="Select a cable">
                <datalist id="cableSelectCrateList"></datalist>
            </div>
            <button type="submit">Connect</button>
        </div>
        <div id="responseOutput"></div>

    </form>

    <script>
        Promise.all([
            fetch('/cables').then(response => response.json()),
            fetch('/modules').then(response => response.json())
        ])
        .then(([cablesData, modulesData]) => {
            const detDatalist = document.getElementById('cableSelectDetList');
            const crateDatalist = document.getElementById('cableSelectCrateList');

            // Populate DetSide datalist with both cables and modules
            for (const cable of cablesData) {
                const option = document.createElement('option');
                option.value = `cable:${cable.name}`;
                option.label = `Cable: ${cable.name}`;
                detDatalist.appendChild(option);
            }

            for (const module of modulesData) {
                const option = document.createElement('option');
                option.value = `module:${module.moduleName}`;
                option.label = `Module: ${module.moduleName}`;
                detDatalist.appendChild(option);
            }

            // Populate CrateSide datalist (cables only)
            for (const cable of cablesData) {
                const option = document.createElement('option');
                option.value = cable.name;
                option.label = cable.name;
                crateDatalist.appendChild(option);
            }
        });

        document.getElementById('cableSelectDet').addEventListener('input', function(event) {
            if (!this.value) return;
            
            const [type, name] = this.value.split(':');
            const endpoint = type === 'module' ? `/modules/${name}` : `/cables/${name}`;
            
            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    const templateType = type === 'module' ? 'module' : data.type;
                    
                    // Fetch the appropriate template
                    fetch(`/cable_templates/${templateType}`)
                        .then(response => response.json())
                        .then(templateData => {
                            const portSelectDet = document.getElementById('portSelectDet');
                            portSelectDet.innerHTML = '';
                            for (const port in templateData.crateSide) {
                                const option = document.createElement('option');
                                option.value = port;
                                option.text = port;
                                portSelectDet.appendChild(option);
                            }
                        });
                });
        });

        document.getElementById('cableSelectCrate').addEventListener('input', function(event) {
            if (!this.value) return;
            
            const cable = this.value;
            fetch(`/cables/${cable}`)
                .then(response => response.json())
                .then(data => {
                    const cableTemplate = data.type;

                    // Fetch the cable template
                    fetch(`/cable_templates/${cableTemplate}`)
                        .then(response => response.json())
                        .then(templateData => {
                            const portSelectCrate = document.getElementById('portSelectCrate');
                            portSelectCrate.innerHTML = '';
                            for (const port in templateData.detSide) {
                                const option = document.createElement('option');
                                option.value = port;
                                option.text = port;
                                portSelectCrate.appendChild(option);
                            }
                        });
                });
        });

        // Handle the form submission
        document.getElementById('connectForm').addEventListener('submit', function(event) {
            event.preventDefault();

            let [type, name] = document.getElementById('cableSelectDet').value.split(':');
            let cable1 = name;  // Use just the name part
            let port1 = document.getElementById('portSelectDet').value;
            let cable2 = document.getElementById('cableSelectCrate').value;
            let port2 = document.getElementById('portSelectCrate').value;

            fetch('/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cable1: cable1,
                    port1: port1,
                    cable2: cable2,
                    port2: port2,
                }),
            })
                .then(response => response.json())
                .then(data =>  {
                    console.log(data)
                    // Get the current time
                    let currentTime = new Date().toLocaleString();

                    // Get the responseOutput element
                    let responseOutput = document.getElementById('responseOutput');

                    // Append the new response to the existing text
                    responseOutput.innerHTML += `<p>Acting on: detside ${cable1}, port ${port1} and crateside ${cable2}, port ${port2}. Response: ${JSON.stringify(data)}, Time: ${currentTime}</p>`;
                    })
                //console.log(data))
                .catch((error) => {
                    console.error('Error:', error);
                });
        });
    </script>
</body>
</html>
