<!DOCTYPE html>
<html>
<body>
<h1>Disconnect Cables</h1>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .box {
            border: 2px solid #000;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .detbox {
            border: 2px solid #000;
            padding: 10px;
            width: 200px; /* adjust as needed */
            height: 200px; /* adjust as needed */
            background-color: /* carbon grey */ #666666;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .cratebox {
            border: 2px solid #000;
            padding: 10px;
            width: 200px; /* adjust as needed */
            height: 200px; /* adjust as needed */
            background-color: #ff0000; /* red */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        select {
            margin-top: 10px;
            padding: 5px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
<form id="disconnectForm">
    <div class="container">
        <div class="detbox">
            <label for="cableSelectDet">Cable DetSide:</label>
            <input list="cableSelectDetList" id="cableSelectDet" name="cableSelectDet" placeholder="Select a cable">
            <datalist id="cableSelectDetList"></datalist>
        </div>
        <div class="box">
            <label for="portSelectDet">Port:</label>
            <select id="portSelectDet"></select>
        </div>
        <div class="box">
            <label for="portSelectCrate">Port:</label>
            <select id="portSelectCrate"></select>
        </div>
        <div class="cratebox">
            <label for="cableSelectCrate">Cable CrateSide:</label>
            <input list="cableSelectCrateList" id="cableSelectCrate" name="cableSelectCrate" placeholder="Select a cable">
            <datalist id="cableSelectCrateList"></datalist>
        </div>
        <button type="submit">Disconnect</button>
    </div>
    <div id="responseOutput"></div>
</form>

<script>
    // Use the same JavaScript code as connect_cables.html with minor adjustments
    Promise.all([
        fetch('/cables').then(response => response.json()),
        fetch('/modules').then(response => response.json())
    ])
    .then(([cablesData, modulesData]) => {
        const detDatalist = document.getElementById('cableSelectDetList');
        const crateDatalist = document.getElementById('cableSelectCrateList');

        // Populate DetSide datalist with both cables and modules
        for (const cable of cablesData) {
            const option = document.createElement('option');
            option.value = `cable:${cable.name}`;
            option.label = `Cable: ${cable.name}`;
            detDatalist.appendChild(option);
        }

        for (const module of modulesData) {
            const option = document.createElement('option');
            option.value = `module:${module.moduleName}`;
            option.label = `Module: ${module.moduleName}`;
            detDatalist.appendChild(option);
        }

                const optionCrate = document.createElement('option');
                optionCrate.value = cable.name;
                optionCrate.text = cable.name;
                cableSelectCrate.appendChild(optionCrate);


                
            }
            
        });
        document.getElementById('cableSelectDet').addEventListener('change', function(event) {
    const cable = event.target.value;
    fetch(`/cables/${cable}`)
    .then(response => response.json())
    .then(data => {
        var cableTemplate = data.type;
        //if not found use "module"
        if (!cableTemplate) {
              cableTemplate = "module";
        }
        // Fetch the cable template
        fetch(`/cable_templates/${cableTemplate}`)
            .then(response => response.json())
            .then(templateData => {
                const portSelectDet = document.getElementById('portSelectDet');
                portSelectDet.innerHTML = '';
                for (const port in templateData.crateSide) {
                    const option = document.createElement('option');
                    option.value = port;
                    option.text = port;// templateData.detSide[port].join('_');
                    portSelectDet.appendChild(option);
                }
            });
        });
    });
    //add modules as cables on detside list
    fetch('/modules')
        .then(response => response.json())
        .then(data => {
            const cableSelectDet = document.getElementById('cableSelectDet');
            const portSelectDet = document.getElementById('portSelectDet');
            const cableSelectCrate = document.getElementById('cableSelectCrate');
            const portSelectCrate = document.getElementById('portSelectCrate');
            //append options
            for (const module of data) {
                const optionDet = document.createElement('option');                
                optionDet.value = module.moduleName;
                optionDet.text = module.moduleName;
                cableSelectDet.appendChild(optionDet);

                // const optionCrate = document.createElement('option');
                // optionCrate.value = module.name;
                // optionCrate.text = module.name;
                // cableSelectCrate.appendChild(optionCrate);
            }
        });

    // same for crate side
    document.getElementById('cableSelectCrate').addEventListener('change', function(event) {
    const cable = event.target.value;
    fetch(`/cables/${cable}`)
    .then(response => response.json())
    .then(data => {
        const cableTemplate = data.type;
     
        // Fetch the cable template
        fetch(`/cable_templates/${cableTemplate}`)
            .then(response => response.json())
            .then(templateData => {
                const portSelectCrate = document.getElementById('portSelectCrate');
                portSelectCrate.innerHTML = '';
                for (const port in templateData.detSide) {
                    const option = document.createElement('option');
                    option.value = port;
                    option.text = port;// templateData.detSide[port].join('_');
                    portSelectCrate.appendChild(option);
                }
            });
        });
    });

    // Handle the form submission
    document.getElementById('disconnectForm').addEventListener('submit', function(event) {
        event.preventDefault();

        let [type, name] = document.getElementById('cableSelectDet').value.split(':');
        let cable1 = name;  // Use just the name part
        let port1 = document.getElementById('portSelectDet').value;
        let cable2 = document.getElementById('cableSelectCrate').value;
        let port2 = document.getElementById('portSelectCrate').value;

        if (!cable1 || !cable2) {
            alert('Please select both cables');
            return;
        }
        if (!port1 && !port2) {
            fetch('/disconnect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cable1: cable1,
                    cable2: cable2,
                }),
            })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch((error) => {
                console.error('Error:', error);
            });
        } else if (port1 && port2) {
            fetch('/disconnect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cable1: cable1,
                    port1: port1,
                    cable2: cable2,
                    port2: port2,
                }),
            })
            .then(response => response.json())
            .then(data =>  {
                        console.log(data)
                        // Get the current time
                        let currentTime = new Date().toLocaleString();
                        // Get the responseOutput element
                        let responseOutput = document.getElementById('responseOutput');

                        // Append the new response to the existing text
                        responseOutput.innerHTML += `<p>Acting on: detside ${cable1}, port ${port1} and crateside ${cable2}, port ${port2}. Response: ${JSON.stringify(data)}, Time: ${currentTime}</p>`;
                        })
            .catch((error) => {
                console.error('Error:', error);
            });
        } else {
            alert('Please select both ports');
            return;
        }
    });

</script>

</body>
</html>